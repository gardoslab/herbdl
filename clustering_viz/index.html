<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>herbaria</title>
    <style>
        .responsive-image {
            max-width: 100%;
            max-height: 325px;
            object-fit: contain;
        }
        .column {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        .image-grid {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: start;
            justify-items: center;
            margin-top: 120px;
        }
        .toggle-button {
            margin-top: 10px;
            flex-direction: row;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .filter-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        .filter-buttons {
            display: flex;
            gap: 10px;
        }
        #legend-search {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .filter-buttons button {
            padding: 8px 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            font-size: 14px;
        }
        .filter-buttons button:hover {
            background-color: #e0e0e0;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/3.1.0/plotly.min.js" integrity="sha512-iXeIWNSxrG0kro2hgWe7onPrTS2g9AeLbojfGJM89zhrunfCSEkHUux9ACjjpem5ob1J2uJ5cNxAn7gJOwygrQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
    <div id="parent-container" style="display: flex; flex-direction: row; align-items: flex-start; gap: 20px; width: 100%">
        <div id="images" style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
            <div class="toggle-button" style="margin-top: 20px;">
                <input type="checkbox" id="lock-axes-toggle" checked>
                <label for="lock-axes-toggle">Lock axes range (-35 to 35)</label>
            </div>
            <button id="clearButton" style="margin-top: 10px;">Clear All Images</button>
            <div id="image-grid-container" class="image-grid">
                <div class="column" class="column">
                    <img id="image-display-0" class="responsive-image" src="" alt="Last Clicked Image 1">
                    <p id="image-name-0" style="margin-top: 10px; text-align: center;">No Image Selected</p>
                    <div id="toggle-button-0" class="toggle-button">    
                        <input type="checkbox" id="image-0-toggle">
                        <label for="toggle-0">keep sample</label>
                    </div>
                </div>
                <div class="column" class="column">
                    <img id="image-display-1" class="responsive-image" src="" alt="Last Clicked Image 2">
                    <p id="image-name-1" style="margin-top: 10px; text-align: center;">No Image Selected</p>
                    <div id="toggle-button-1" class="toggle-button">
                        <input type="checkbox" id="image-1-toggle">
                        <label for="toggle-1">keep sample</label>
                    </div>
                </div>
                <div class="column" class="column" style="grid-column: 1 / span 2; display: flex; flex-direction: column; align-items: center;">
                    <img id="image-display-2" class="responsive-image" src="" alt="Last Clicked Image 3">
                    <p id="image-name-2" style="margin-top: 10px; text-align: center;">No Image Selected</p>
                    <div id="toggle-button-2" class="toggle-button">
                        <input type="checkbox" id="image-2-toggle">
                        <label for="toggle-2">keep sample</label>
                    </div>
            </div>
            <div></div>
        </div>
        </div>
        <div style="flex: 2; display: flex; flex-direction: column;">
            <div class="filter-controls">
                <input type="text" id="legend-search" placeholder="Search species (e.g., 'Aster', 'Erigeron')...">
                <div class="filter-buttons">
                    <button id="select-all-btn">Select All</button>
                    <button id="clear-all-btn">Clear All</button>
                    <button id="reset-filter-btn">Reset Filter</button>
                </div>
            </div>
            <div id="plot-div" style="width: 100%; height: 800px">
                <!-- Plotly chart will be drawn inside this DIV -->
            </div>
        </div>
    </div>

    <!-- Floating image preview (hidden by default) -->
    <img id="hover-preview" src="" style="display:none; position:fixed; pointer-events:none; max-width:200px; z-index:1000; border:2px solid #333; background:#fff;"/>
    <script>
        // change the json file here to visualize a different file 
        fetch("asteraceae_outliers_10_95th_astera_50_checkpoint-1300.json") //prev: asteraceae_tsne_plot_astera_50_checkpoint-1300
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json(); // parse the JSON data
            })
            .then(data => {
                const plotData = data;

                // render the plot using plotly
                Plotly.newPlot('plot-div', plotData.data, plotData.layout);

                var tsnePlot = document.getElementById('plot-div');

                // set initial axes range to locked by default
                Plotly.relayout('plot-div', {
                    'xaxis.range': [-35, 35],
                    'yaxis.range': [-35, 35],
                    'xaxis.autorange': false,
                    'yaxis.autorange': false
                });

                // handle lock axes checkbox toggle
                document.getElementById('lock-axes-toggle').addEventListener('change', function(e) {
                    if (e.target.checked) {
                        // lock axes to -35, 35
                        Plotly.relayout('plot-div', {
                            'xaxis.range': [-35, 35],
                            'yaxis.range': [-35, 35],
                            'xaxis.autorange': false,
                            'yaxis.autorange': false
                        });
                    } else {
                        // enable autorange
                        Plotly.relayout('plot-div', {
                            'xaxis.autorange': true,
                            'yaxis.autorange': true
                        });
                    }
                });

                // legend filtering functionality
                const searchInput = document.getElementById('legend-search');
                const selectAllBtn = document.getElementById('select-all-btn');
                const clearAllBtn = document.getElementById('clear-all-btn');
                const resetFilterBtn = document.getElementById('reset-filter-btn');

                // get all trace names/labels
                const allTraceNames = plotData.data.map((trace, idx) => ({
                    name: trace.legendgroup || trace.name || '',
                    index: idx
                }));

                // function to filter traces based on search text
                function filterTraces(searchText) {
                    const searchLower = searchText.toLowerCase();
                    return allTraceNames.filter(trace =>
                        trace.name.toLowerCase().includes(searchLower)
                    );
                }

                // function to update trace visibility
                function updateTraceVisibility(traceIndices, visible) {
                    const visibility = plotData.data.map((trace, idx) => {
                        if (traceIndices.includes(idx)) {
                            return visible;
                        }
                        return trace.visible;
                    });
                    Plotly.restyle('plot-div', {'visible': visibility});
                }

                // search input handler
                searchInput.addEventListener('input', function(e) {
                    const searchText = e.target.value;
                    if (searchText === '') {
                        return; // do nothing if search is empty
                    }

                    const matchingTraces = filterTraces(searchText);
                    const matchingIndices = matchingTraces.map(t => t.index);

                    // hide all traces first, then show matching ones
                    const visibility = plotData.data.map((trace, idx) =>
                        matchingIndices.includes(idx) ? true : 'legendonly'
                    );
                    Plotly.restyle('plot-div', {'visible': visibility});
                });

                // select all button - selects all traces matching current search
                selectAllBtn.addEventListener('click', function() {
                    const searchText = searchInput.value;
                    let tracesToShow;

                    if (searchText === '') {
                        // select all traces
                        tracesToShow = allTraceNames.map(t => t.index);
                    } else {
                        // select only filtered traces
                        const matchingTraces = filterTraces(searchText);
                        tracesToShow = matchingTraces.map(t => t.index);
                    }

                    const visibility = plotData.data.map((trace, idx) =>
                        tracesToShow.includes(idx) ? true : trace.visible
                    );
                    Plotly.restyle('plot-div', {'visible': visibility});
                });

                // clear all button - hides all traces matching current search
                clearAllBtn.addEventListener('click', function() {
                    const searchText = searchInput.value;
                    let tracesToHide;

                    if (searchText === '') {
                        // hide all traces
                        tracesToHide = allTraceNames.map(t => t.index);
                    } else {
                        // hide only filtered traces
                        const matchingTraces = filterTraces(searchText);
                        tracesToHide = matchingTraces.map(t => t.index);
                    }

                    const visibility = plotData.data.map((trace, idx) =>
                        tracesToHide.includes(idx) ? 'legendonly' : trace.visible
                    );
                    Plotly.restyle('plot-div', {'visible': visibility});
                });

                // reset filter button - clears search and shows all traces
                resetFilterBtn.addEventListener('click', function() {
                    searchInput.value = '';
                    const visibility = plotData.data.map(() => true);
                    Plotly.restyle('plot-div', {'visible': visibility});
                });

                // set the directory path for the images
                const dirPath = '/projectnb/herbdl/data/kaggle-herbaria/herbarium-2022/train_images';
                const thumbnailDir = '/projectnb/herbdl/workspaces/tgardos/herbdl/clustering_viz/thumbnails';
                const sccLink = 'https://scc-ondemand1.bu.edu/pun/sys/dashboard/files/fs/';

                // hover over a point and preview the image, unhover when away from a point
                const hoverPreview = document.getElementById('hover-preview');
                tsnePlot.on('plotly_hover', function(eventData){
                    const point = eventData.points[0];
                    const imagePath = point.customdata;
                    if (imagePath) {
                        // use thumbnails for hover preview (much faster loading)
                        hoverPreview.src = sccLink + thumbnailDir + imagePath[0];
                        hoverPreview.style.display = 'block';
                    }
                });
                
                tsnePlot.on('plotly_unhover', function(){
                    hoverPreview.style.display = 'none';
                });

                // move preview image with mouse
                tsnePlot.addEventListener('mousemove', function(e){
                    hoverPreview.style.left = (e.clientX + 38) + 'px';
                    // check boundaries to keep the preview image within the viewport
                    if (e.clientY > 350){
                        hoverPreview.style.top = (e.clientY - 350) + 'px';
                    } else {
                        hoverPreview.style.top = (e.clientY + 38) + 'px';
                    }
                });
                
                // selecting images by clicking on points
                tsnePlot.on('plotly_click', function(data){
                    const clickedImages = JSON.parse(localStorage.getItem('clickedImages')) || [];
                    const clickedNames = JSON.parse(localStorage.getItem('clickedNames')) || [];
                    const clickedPoint = data.points[0];

                    // get the image path from customdata
                    const imagePath = clickedPoint.customdata; 

                    // get the species name for the clicked point
                    const imgName = clickedPoint.data.legendgroup;
                    
                    // check which spots are able to be filled 
                    const checkedBoxArr = [];
                    for (let i = 0; i < 3; i++) {
                        const checkbox = document.getElementById(`image-${i}-toggle`);
                        if(!checkbox.checked) {
                            checkedBoxArr.push(i);
                        }
                    }
                    
                    // populate the images
                    if (imagePath) {
                        // add new image path to the array - use full resolution for clicked images
                        clickedImages.unshift(sccLink + dirPath + imagePath[0]);

                        // keep the last three entries only
                        if (clickedImages.length > 3){
                            clickedImages.pop();
                        }

                        // save the updated array to local storage
                        localStorage.setItem('clickedImages', JSON.stringify(clickedImages));

                        // update the displayed images
                        for (let i of checkedBoxArr) {
                            document.getElementById(`image-display-${i}`).src = clickedImages[i] || '';
                        }
                    }
                    
                    // populate the species names 
                    if (imgName) {
                        // add the new species name to the array 
                        clickedNames.unshift(imgName);

                        // keep the last three entries only 
                        if (clickedNames.length > 3) {
                            clickedNames.pop();
                        }

                        // save the updated array to local storage 
                        localStorage.setItem('clickedNames', JSON.stringify(clickedNames));

                        // update the displayed names 
                        for (let i of checkedBoxArr) {
                            document.getElementById(`image-name-${i}`).textContent = clickedNames[i] || '';
                        }
                    }
                });
            })
            .catch(error => {
                console.error("Error loading JSON data:", error);
        });

        // clear all of the images in that are displayed
        document.getElementById('clearButton').addEventListener('click', function() {
            // clear the displayed images
            document.getElementById('image-display-0').src = '';
            document.getElementById('image-display-1').src = '';
            document.getElementById('image-display-2').src = '';

            // clear the species names associated with the images
            document.getElementById('image-name-0').textContent = 'No Image Selected';
            document.getElementById('image-name-1').textContent = 'No Image Selected';
            document.getElementById('image-name-2').textContent = 'No Image Selected';

            // uncheck all the image checkboxes
            for (let i = 0; i < 3; i++) {
                document.getElementById(`image-${i}-toggle`).checked = false;
            }

            // clear the stack in localStorage
            localStorage.setItem('clickedImages', JSON.stringify([]));
            localStorage.setItem('clickedNames', JSON.stringify([]));
        });
    </script>
</body>
</html>